"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AccumulativeSelectionStrategy = void 0;
const common_1 = require("@fleet-sdk/common");
/**
 * Accumulative selection strategy accumulates inputs until the target
 * value is reached, skipping detrimental inputs.
 */
class AccumulativeSelectionStrategy {
    _inputs;
    select(inputs, target) {
        this._inputs = inputs;
        let selection = [];
        if (!(0, common_1.isEmpty)(target.tokens)) {
            selection = this._selectTokens(target.tokens);
        }
        const selectedNanoErgs = (0, common_1.sumBy)(selection, (input) => input.value);
        if (((0, common_1.isUndefined)(target.nanoErgs) && (0, common_1.isEmpty)(target.tokens)) ||
            (!(0, common_1.isUndefined)(target.nanoErgs) && selectedNanoErgs < target.nanoErgs)) {
            const targetAmount = !(0, common_1.isUndefined)(target.nanoErgs)
                ? target.nanoErgs - selectedNanoErgs
                : undefined;
            selection = selection.concat(this._select(targetAmount));
        }
        return selection;
    }
    _selectTokens(targets) {
        let selection = [];
        for (const target of targets) {
            const targetAmount = !(0, common_1.isUndefined)(target.amount)
                ? target.amount - (0, common_1.utxoSum)(selection, target.tokenId)
                : undefined;
            if (targetAmount && targetAmount <= common_1._0n) {
                continue;
            }
            selection = selection.concat(this._select(targetAmount, target.tokenId));
        }
        return selection;
    }
    _select(target, tokenId) {
        let acc = common_1._0n;
        let selection = [];
        if ((0, common_1.isUndefined)(target)) {
            if (tokenId) {
                selection = this._inputs.filter((x) => x.assets.some((asset) => asset.tokenId === tokenId));
            }
            else {
                selection = this._inputs;
            }
        }
        else {
            for (let i = 0; i < this._inputs.length && acc < target; i++) {
                if (tokenId) {
                    for (const token of this._inputs[i].assets) {
                        if (token.tokenId !== tokenId) {
                            continue;
                        }
                        acc += token.amount;
                        selection.push(this._inputs[i]);
                    }
                }
                else {
                    acc += this._inputs[i].value;
                    selection.push(this._inputs[i]);
                }
            }
        }
        if (!(0, common_1.isEmpty)(selection)) {
            this._inputs = this._inputs.filter((input) => !selection.includes(input));
        }
        return selection;
    }
}
exports.AccumulativeSelectionStrategy = AccumulativeSelectionStrategy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjdW11bGF0aXZlU2VsZWN0aW9uU3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvYnVpbGRlci9zZWxlY3Rvci9zdHJhdGVnaWVzL2FjY3VtdWxhdGl2ZVNlbGVjdGlvblN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhDQUE4RTtBQUk5RTs7O0dBR0c7QUFDSCxNQUFhLDZCQUE2QjtJQUNoQyxPQUFPLENBQWlCO0lBRWhDLE1BQU0sQ0FBQyxNQUFxQixFQUFFLE1BQXVCO1FBQ25ELElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBRXRCLElBQUksU0FBUyxHQUFrQixFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLElBQUEsZ0JBQU8sRUFBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDM0IsU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQy9DO1FBRUQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFBLGNBQUssRUFBQyxTQUFTLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRSxJQUNFLENBQUMsSUFBQSxvQkFBVyxFQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFBLGdCQUFPLEVBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3hELENBQUMsQ0FBQyxJQUFBLG9CQUFXLEVBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFDckU7WUFDQSxNQUFNLFlBQVksR0FBRyxDQUFDLElBQUEsb0JBQVcsRUFBQyxNQUFNLENBQUMsUUFBUSxDQUFDO2dCQUNoRCxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxnQkFBZ0I7Z0JBQ3BDLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFF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